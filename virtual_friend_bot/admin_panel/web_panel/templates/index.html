<!-- web_panel/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å –ë–æ—Ç–æ–≤</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <style>
        body { padding-top: 60px; }
        .stat-card { cursor: pointer; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        #chat-container { min-height: 400px; }
        .sentiment-positive { color: green; }
        .sentiment-negative { color: red; }
        .sentiment-neutral { color: gray; }
        .tag-badge { margin-right: 5px; margin-bottom: 5px; }
        .toast { z-index: 1055; } /* –í—ã—à–µ, —á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Bootstrap */
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ü§ñ –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å –ë–æ—Ç–æ–≤</a>
            <a href="/logout" class="btn btn-outline-light">üö™ –í—ã–π—Ç–∏</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4" id="stats-container">
            <div class="col-md-3">
                <div class="card stat-card text-white bg-primary">
                    <div class="card-body">
                        <h5>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
                        <h2 id="total-users">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white bg-success">
                    <div class="card-body">
                        <h5>üí≥ –û–ø–ª–∞—Ç—ã</h5>
                        <h2 id="total-paid">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white bg-warning">
                    <div class="card-body">
                        <h5>‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</h5>
                        <h2 id="total-active">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white bg-info">
                    <div class="card-body">
                        <h5>üìä DAU</h5>
                        <h2 id="dau">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card text-white bg-secondary">
                    <div class="card-body">
                        <h5>üìà Retention (7d)</h5>
                        <h2 id="retention">0%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card text-white bg-success">
                    <div class="card-body">
                        <h5>üí∞ LTV (–Ω–∞ –ø–ª–∞—Ç—è—â–µ–≥–æ)</h5>
                        <h2 id="ltv">0‚ÇΩ</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card text-white bg-warning">
                    <div class="card-body">
                        <h5>üìâ MAU</h5>
                        <h2 id="mau">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π</div>
                    <div class="card-body">
                        <canvas id="sentimentChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">üè∑Ô∏è –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã</div>
                    <div class="card-body">
                        <canvas id="tagsChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —á–∞—Ç–æ–≤ -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>üìú –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</h4>
            </div>
            <div class="card-body">
                <table id="chats-table" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ë–æ—Ç</th>
                            <th>–Ø–∑—ã–∫</th>
                            <th>–†–µ–∂–∏–º</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chat in chats %}
                        <tr>
                            <td>
                                <strong>{{ chat.first_name }} {{ chat.last_name }}</strong><br>
                                <small class="text-muted">@{{ chat.username or '‚Äî' }}</small><br>
                                <small class="text-muted">ID: {{ chat.user_id }}</small>
                            </td>
                            <td><span class="badge bg-{{ 'success' if chat.bot_type == 'evg' else 'danger' }}">{{ chat.bot_type }}</span></td>
                            <td><span class="badge bg-secondary">{{ chat.language or 'ru' }}</span></td>
                            <td>
                                {% if chat.bot_type == 'evg' %}
                                    {% if chat.relationship_mode == 1 %}
                                        <span class="badge bg-danger">üíñ –í–æ–∑–ª—é–±–ª–µ–Ω–Ω–∞—è</span>
                                    {% else %}
                                        <span class="badge bg-info">üå∏ –ü–æ–¥—Ä—É–≥–∞</span>
                                    {% endif %}
                                {% else %}
                                    {% if chat.relationship_mode == 1 %}
                                        <span class="badge bg-dark">üñ§ –õ—é–±–æ–≤—å</span>
                                    {% elif chat.relationship_mode == 2 %}
                                        <span class="badge bg-success">ü§ù –°–æ—é–∑–Ω–∏–∫</span>
                                    {% else %}
                                        <span class="badge bg-warning">‚öîÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-chat" data-user-id="{{ chat.user_id }}" data-bot-type="{{ chat.bot_type }}">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                <button class="btn btn-sm btn-outline-success export-chat" data-user-id="{{ chat.user_id }}" data-bot-type="{{ chat.bot_type }}">üì• Excel</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ß–∞—Ç -->
        <div class="card" id="chat-card" style="display:none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 id="chat-title">–ü–µ—Ä–µ–ø–∏—Å–∫–∞</h4>
                <button class="btn btn-sm btn-outline-secondary" id="refresh-chat">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="card-body" id="chat-container">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–µ—Å—Ç–æ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

    <!-- –í–∞—à —Å–∫—Ä–∏–ø—Ç -->
    <script src="/static/script.js"></script>
    <script>
        $(document).ready(function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTables —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º i18n
            $('#chats-table').DataTable({
                "language": {
                    "url": "/static/i18n/ru.json" // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                },
                "order": [[ 0, "desc" ]] // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            });
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
